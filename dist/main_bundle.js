(()=>{var e={336:e=>{var t;self,t=()=>(()=>{var e={934:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.generateQueryString=t.tokenResponseToOAuth2Token=t.OAuth2Client=void 0;const n=r(443),i=r(618);function s(e,t){return new URL(e,t).toString()}function o(e){return e.then((e=>{var t;return{accessToken:e.access_token,expiresAt:e.expires_in?Date.now()+1e3*e.expires_in:null,refreshToken:null!==(t=e.refresh_token)&&void 0!==t?t:null}}))}function a(e){return new URLSearchParams(Object.fromEntries(Object.entries(e).filter((([e,t])=>void 0!==t)))).toString()}t.OAuth2Client=class{constructor(e){this.discoveryDone=!1,this.serverMetadata=null,(null==e?void 0:e.fetch)||(e.fetch=fetch),this.settings=e}async refreshToken(e){if(!e.refreshToken)throw new Error("This token didn't have a refreshToken. It's not possible to refresh this");const t={grant_type:"refresh_token",refresh_token:e.refreshToken};return this.settings.clientSecret||(t.client_id=this.settings.clientId),o(this.request("tokenEndpoint",t))}async clientCredentials(e){var t;const r=["client_id","client_secret","grant_type","scope"];if((null==e?void 0:e.extraParams)&&Object.keys(e.extraParams).filter((e=>r.includes(e))).length>0)throw new Error(`The following extraParams are disallowed: '${r.join("', '")}'`);const n={grant_type:"client_credentials",scope:null===(t=null==e?void 0:e.scope)||void 0===t?void 0:t.join(" "),...null==e?void 0:e.extraParams};if(!this.settings.clientSecret)throw new Error("A clientSecret must be provided to use client_credentials");return o(this.request("tokenEndpoint",n))}async password(e){var t;const r={grant_type:"password",...e,scope:null===(t=e.scope)||void 0===t?void 0:t.join(" ")};return o(this.request("tokenEndpoint",r))}get authorizationCode(){return new i.OAuth2AuthorizationCodeClient(this)}async introspect(e){const t={token:e.accessToken,token_type_hint:"access_token"};return this.request("introspectionEndpoint",t)}async getEndpoint(e){if(void 0!==this.settings[e])return s(this.settings[e],this.settings.server);if("discoveryEndpoint"!==e&&(await this.discover(),void 0!==this.settings[e]))return s(this.settings[e],this.settings.server);if(!this.settings.server)throw new Error(`Could not determine the location of ${e}. Either specify ${e} in the settings, or the "server" endpoint to let the client discover it.`);switch(e){case"authorizationEndpoint":return s("/authorize",this.settings.server);case"tokenEndpoint":return s("/token",this.settings.server);case"discoveryEndpoint":return s("/.well-known/oauth-authorization-server",this.settings.server);case"introspectionEndpoint":return s("/introspect",this.settings.server)}}async discover(){var e;if(this.discoveryDone)return;let t;this.discoveryDone=!0;try{t=await this.getEndpoint("discoveryEndpoint")}catch(e){return void console.warn('[oauth2] OAuth2 discovery endpoint could not be determined. Either specify the "server" or "discoveryEndpoint')}const r=await this.settings.fetch(t,{headers:{Accept:"application/json"}});if(!r.ok)return;if(!(null===(e=r.headers.get("Content-Type"))||void 0===e?void 0:e.startsWith("application/json")))return void console.warn("[oauth2] OAuth2 discovery endpoint was not a JSON response. Response is ignored");this.serverMetadata=await r.json();const n=[["authorization_endpoint","authorizationEndpoint"],["token_endpoint","tokenEndpoint"],["introspection_endpoint","introspectionEndpoint"]];if(null!==this.serverMetadata){for(const[e,r]of n)this.serverMetadata[e]&&(this.settings[r]=s(this.serverMetadata[e],t));this.serverMetadata.token_endpoint_auth_methods_supported&&!this.settings.authenticationMethod&&(this.settings.authenticationMethod=this.serverMetadata.token_endpoint_auth_methods_supported[0])}}async request(e,t){const r=await this.getEndpoint(e),i={"Content-Type":"application/x-www-form-urlencoded"};let s=this.settings.authenticationMethod;switch(s||(s=this.settings.clientSecret?"client_secret_basic":"client_secret_post"),s){case"client_secret_basic":i.Authorization="Basic "+btoa(this.settings.clientId+":"+this.settings.clientSecret);break;case"client_secret_post":t.client_id=this.settings.clientId,this.settings.clientSecret&&(t.client_secret=this.settings.clientSecret);break;default:throw new Error("Authentication method not yet supported:"+s+". Open a feature request if you want this!")}const o=await this.settings.fetch(r,{method:"POST",body:a(t),headers:i});if(o.ok)return await o.json();let c,h,u;throw o.headers.has("Content-Type")&&o.headers.get("Content-Type").startsWith("application/json")&&(c=await o.json()),(null==c?void 0:c.error)?(h="OAuth2 error "+c.error+".",c.error_description&&(h+=" "+c.error_description),u=c.error):(h="HTTP Error "+o.status+" "+o.statusText,401===o.status&&this.settings.clientSecret&&(h+=". It's likely that the clientId and/or clientSecret was incorrect"),u=null),new n.OAuth2Error(h,u,o.status)}},t.tokenResponseToOAuth2Token=o,t.generateQueryString=a},618:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getCodeChallenge=t.generateCodeVerifier=t.OAuth2AuthorizationCodeClient=void 0;const n=r(934),i=r(443);async function s(e){const t=o();if(null==t?void 0:t.subtle)return["S256",c(await t.subtle.digest("SHA-256",a(e)))];{const t=r(212).createHash("sha256");return t.update(a(e)),["S256",t.digest("base64url")]}}function o(){if("undefined"!=typeof window&&window.crypto)return window.crypto;if("undefined"!=typeof self&&self.crypto)return self.crypto;const e=r(212);return e.webcrypto?e.webcrypto:null}function a(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t}function c(e){return btoa(String.fromCharCode(...new Uint8Array(e))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}t.OAuth2AuthorizationCodeClient=class{constructor(e){this.client=e}async getAuthorizeUri(e){const[t,r]=await Promise.all([e.codeVerifier?s(e.codeVerifier):void 0,this.client.getEndpoint("authorizationEndpoint")]),i={client_id:this.client.settings.clientId,response_type:"code",redirect_uri:e.redirectUri,code_challenge_method:null==t?void 0:t[0],code_challenge:null==t?void 0:t[1]};return e.state&&(i.state=e.state),e.scope&&(i.scope=e.scope.join(" ")),r+"?"+(0,n.generateQueryString)(i)}async getTokenFromCodeRedirect(e,t){const{code:r}=await this.validateResponse(e,{state:t.state});return this.getToken({code:r,redirectUri:t.redirectUri,codeVerifier:t.codeVerifier})}async validateResponse(e,t){var r;const n=new URL(e).searchParams;if(n.has("error"))throw new i.OAuth2Error(null!==(r=n.get("error_description"))&&void 0!==r?r:"OAuth2 error",n.get("error"),0);if(!n.has("code"))throw new Error(`The url did not contain a code parameter ${e}`);if(t.state&&t.state!==n.get("state"))throw new Error(`The "state" parameter in the url did not match the expected value of ${t.state}`);return{code:n.get("code"),scope:n.has("scope")?n.get("scope").split(" "):void 0}}async getToken(e){const t={grant_type:"authorization_code",code:e.code,redirect_uri:e.redirectUri,code_verifier:e.codeVerifier};return(0,n.tokenResponseToOAuth2Token)(this.client.request("tokenEndpoint",t))}},t.generateCodeVerifier=async function(){const e=o();if(e){const t=new Uint8Array(32);return e.getRandomValues(t),c(t)}{const e=r(212);return new Promise(((t,r)=>{e.randomBytes(32,((e,n)=>{e&&r(e),t(n.toString("base64url"))}))}))}},t.getCodeChallenge=s},443:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuth2Error=void 0;class r extends Error{constructor(e,t,r){super(e),this.oauth2Code=t,this.httpCode=r}}t.OAuth2Error=r},13:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OAuth2Fetch=void 0,t.OAuth2Fetch=class{constructor(e){this.token=null,this.activeRefresh=null,this.refreshTimer=null,void 0===(null==e?void 0:e.scheduleRefresh)&&(e.scheduleRefresh=!0),this.options=e,e.getStoredToken&&(async()=>{this.token=await e.getStoredToken()})(),this.scheduleRefresh()}async fetch(e,t){const r=new Request(e,t);return this.mw()(r,(e=>fetch(e)))}mw(){return async(e,t)=>{const r=await this.getAccessToken();let n=e.clone();n.headers.set("Authorization","Bearer "+r);let i=await t(n);if(!i.ok&&401===i.status){const r=await this.refreshToken();n=e.clone(),n.headers.set("Authorization","Bearer "+r.accessToken),i=await t(n)}return i}}async getToken(){return this.token&&(null===this.token.expiresAt||this.token.expiresAt>Date.now())?this.token:this.refreshToken()}async getAccessToken(){return(await this.getToken()).accessToken}async refreshToken(){var e,t;if(this.activeRefresh)return this.activeRefresh;const r=this.token;this.activeRefresh=(async()=>{var e,t;let n=null;try{(null==r?void 0:r.refreshToken)&&(n=await this.options.client.refreshToken(r))}catch(e){console.warn("[oauth2] refresh token not accepted, we'll try reauthenticating")}if(n||(n=await this.options.getNewToken()),!n){const r=new Error("Unableto obtain OAuth2 tokens, a full reauth may be needed");throw null===(t=(e=this.options).onError)||void 0===t||t.call(e,r),r}return n})();try{const r=await this.activeRefresh;return this.token=r,null===(t=(e=this.options).storeToken)||void 0===t||t.call(e,r),this.scheduleRefresh(),r}catch(e){throw this.options.onError&&this.options.onError(e),e}finally{this.activeRefresh=null}}scheduleRefresh(){var e;if(!this.options.scheduleRefresh)return;if(this.refreshTimer&&(clearTimeout(this.refreshTimer),this.refreshTimer=null),!(null===(e=this.token)||void 0===e?void 0:e.expiresAt)||!this.token.refreshToken)return;const t=this.token.expiresAt-Date.now();t<12e4||(this.refreshTimer=setTimeout((async()=>{try{await this.refreshToken()}catch(e){console.error("[fetch-mw-oauth2] error while doing a background OAuth2 auto-refresh",e)}}),t-6e4))}}},212:()=>{}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}var n={};return(()=>{"use strict";var e=n;Object.defineProperty(e,"__esModule",{value:!0}),e.OAuth2Error=e.OAuth2Fetch=e.generateCodeVerifier=e.OAuth2AuthorizationCodeClient=e.OAuth2Client=void 0;var t=r(934);Object.defineProperty(e,"OAuth2Client",{enumerable:!0,get:function(){return t.OAuth2Client}});var i=r(618);Object.defineProperty(e,"OAuth2AuthorizationCodeClient",{enumerable:!0,get:function(){return i.OAuth2AuthorizationCodeClient}}),Object.defineProperty(e,"generateCodeVerifier",{enumerable:!0,get:function(){return i.generateCodeVerifier}});var s=r(13);Object.defineProperty(e,"OAuth2Fetch",{enumerable:!0,get:function(){return s.OAuth2Fetch}});var o=r(443);Object.defineProperty(e,"OAuth2Error",{enumerable:!0,get:function(){return o.OAuth2Error}})})(),n})(),e.exports=t()}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var s=t[n]={exports:{}};return e[n](s,s.exports,r),s.exports}(()=>{"use strict";var e=r(336);let t,n=document.createElement("template");n.innerHTML='\n    <style>\n    </style>\n    <div id="ifm_datasphere" name="ifm_datasphere">\n      <slot name="content"></slot>\n    </div>\n    <script id="oView" name="oView" type="sapui5/xmlview">\n      <mvc:View\n        controllerName="ifm.datasphere.initial"\n        xmlns:core="sap.ui.core"\n        xmlns:m="sap.m"\n        xmlns:mvc="sap.ui.core.mvc">\n        <m:VBox>        \n          <m:FlexBox\n            height="100%">\n              <m:Button text="Execute Task Chain"\n                icon="sap-icon://process"\n                press="onPress"\n                ariaDescribedBy="defaultButtonDescription genericButtonDescription">\n              </m:Button>\n          </m:FlexBox>\n        </m:VBox>\n      </mvc:View>\n    <\/script>\n  ';class i extends HTMLElement{constructor(){super(),t=this.attachShadow({mode:"open"}),t.appendChild(n.content.cloneNode(!0)),this._export_settings={},this._export_settings.DSP_serverURL="",this._export_settings.DSP_clientID="",this._export_settings.DSP_apiSecret="",this._export_settings.DSP_oAuthURL="",this._export_settings.DSP_tokenURL="",this._export_settings.DSP_taskChain="",this._export_settings.DSP_redirectURL="",this._export_settings.DSP_OAuth2Client=null,this._export_settings.DSP_authorizationCode="",this._export_settings.DSP_token=""}onCustomWidgetResize(e,t){}connectedCallback(){}disconnectedCallback(){}onCustomWidgetBeforeUpdate(e){}onCustomWidgetAfterUpdate(e){this.buildUI(this)}get DSP_serverURL(){return this._export_settings.DSP_serverURL}set DSP_serverURL(e){this._export_settings.DSP_serverURL=e}get DSP_redirectURL(){return this._export_settings.DSP_redirectURL}set DSP_redirectURL(e){this._export_settings.DSP_redirectURL=e}get DSP_clientID(){return this._export_settings.DSP_clientID}set DSP_clientID(e){this._export_settings.DSP_clientID=e}get DSP_apiSecret(){return this._export_settings.DSP_apiSecret}set DSP_apiSecret(e){this._export_settings.DSP_apiSecret=e}get DSP_oAuthURL(){return this._export_settings.DSP_oAuthURL}set DSP_oAuthURL(e){this._export_settings.DSP_oAuthURL=e}get DSP_tokenURL(){return this._export_settings.DSP_tokenURL}set DSP_tokenURL(e){this._export_settings.DSP_tokenURL=e}get DSP_taskChain(){return this._export_settings.DSP_taskChain}set DSP_taskChain(e){this._export_settings.DSP_taskChain=e}static get observedAttributes(){return["DSP_serverURL","DSP_clientID","DSP_apiSecret","DSP_oAuthURL","DSP_tokenURL","DSP_taskChain","DSP_redirectURL"]}performOAuth2(){this.setOAuth2Client(),this.getAccessToken(),console.log(this._export_settings.DSP_token)}setOAuth2Client(){encodeURI(`${this._export_settings.DSP_oAuthURL}?response_type=code&client_id=${this._export_settings.DSP_clientID}&redirect_uri=${this._export_settings.DSP_redirectURL}`),this._export_settings.DSP_OAuth2Client=new e.OAuth2Client({server:this._export_settings.DSP_serverURL,clientId:this._export_settings.DSP_clientID,clientSecret:this._export_settings.DSP_apiSecret,tokenEndpoint:"/oauth/token",authorizationEndpoint:"/oauth/authorize"})}extractAuthorizationCode(){const e=new URLSearchParams(window.location.search);this._export_settings.DSP_authorizationCode=e.get("code")}async getAuthorizationCode(){console.log(this._export_settings.DSP_OAuth2Client),document.location=await this._export_settings.DSP_OAuth2Client.authorizationCode.getAuthorizeUri({redirectUri:this._export_settings.DSP_redirectURL})}async getAccessToken(){const e=encodeURI(`${this._export_settings.DSP_serverURL}/oauth/token`);var t="grant_type=authorization_code&code="+this._export_settings.DSP_authorizationCode+"&client_id="+this._export_settings.DSP_clientID+"&client_secret="+encodeURIComponent(this._export_settings.DSP_apiSecret)+"&redirect_uri="+encodeURIComponent(this._export_settings.DSP_redirectURL),r=new XMLHttpRequest;r.open("POST",e,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8"),r.setRequestHeader("Accept","*/*"),r.setRequestHeader("x-sap-sac-custom-auth","true"),r.onerror=e=>{console.log(e)},r.onreadystatechange=e=>{if(4==r.readyState&&(r.status>=200&&r.status<300||304===r.status)){var t=JSON.parse(r.responseText),n={token:t.access_token,expires_in:new Date((new Date).getTime()+1e3*(t.expires_in-300))};console.log(n)}},r.send(t)}attributeChangedCallback(e,t,r){t!=r&&(this[e]=r)}buildUI(e){var r=e;let n=document.createElement("div");n.slot="content",r.appendChild(n),sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/library"],(function(e){return e.extend("ifm.datasphere.initial",{onPress:function(e){r.performOAuth2()}})})),new sap.ui.core.mvc.XMLView({viewContent:jQuery(t.getElementById("oView")).html()}).placeAt(n)}}customElements.define("com-ifm-datasphere",i)})()})();